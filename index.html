<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lion Widget Final Audio</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(-45deg, #e0c3fc, #8ec5fc, #90f7ec, #ffecd2);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .stage {
            width: 100%;
            height: 100%;
            position: relative;
            /* ç¡®ä¿ç‹®å­ç»å¯¹å±…ä¸­ */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* --- å·¦ä¸Šè§’ï¼šæ”¶è—é¦†å°ç»„ä»¶ --- */
        .collection-widget {
            position: absolute;
            top: 2vh; 
            left: 3vw;
            z-index: 30; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
            
            font-size: clamp(10px, 3.5vw, 16px);
            
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(6px);
            border: 0.5px solid rgba(255,255,255,0.6);
            border-radius: 12px;
            
            padding: 0.35em 0.8em 0.35em 0.35em; 
            
            display: flex;
            align-items: center;
            gap: 0.5em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            pointer-events: none;
            max-width: 50vw; 
        }

        .cw-icon-box {
            flex-shrink: 0; 
            width: 2.2em;
            height: 2.2em;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.7);
            border-radius: 50%;
            padding: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .cw-icon-box img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            display: block;
        }

        .cw-info {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
            min-width: 0; 
        }
        
        .cw-label {
            font-size: 0.75em;
            color: #777;
            font-weight: 700;
            text-transform: uppercase;
            white-space: nowrap; 
        }
        
        .cw-value {
            font-size: 1.1em;
            color: #6200EA;
            font-weight: 800;
            white-space: nowrap;
        }

        /* --- ç‹®å­ä¸»ä½“ (ç»å¯¹å±…ä¸­ + å æ»¡å®½åº¦) --- */
        #pet-image {
            /* å®½åº¦å æ»¡ */
            width: 90vw; 
            /* å¦‚æœåœ¨å¹³æ¿ä¸Šï¼Œé™åˆ¶ä¸€ä¸‹æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢å¤ªå¤§ */
            max-width: 450px; 
            
            /* é«˜åº¦è‡ªé€‚åº”ï¼Œä½†é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢é®æŒ¡ä¸Šä¸‹ç»„ä»¶ */
            height: auto;
            max-height: 75vh; 
            
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(0 1vh 3vh rgba(0,0,0,0.15));
            
            z-index: 10; /* åœ¨ç»„ä»¶ä¸‹å±‚ */
        }
        #pet-image:active { transform: scale(0.96); }

        /* --- åº•éƒ¨è®¡æ—¶å™¨ (è´´åº•é€‚é…) --- */
        .time-pill {
            /* ç»å¯¹å®šä½è´´åº• */
            position: absolute;
            bottom: 4vh; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 30; /* ä¿è¯åœ¨ç‹®å­ä¸Šé¢ */

            font-size: clamp(10px, 3.5vw, 16px);
            padding: 0.3em 0.8em;
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            border: 0.5px solid rgba(255,255,255,0.6);
            
            font-family: 'Courier New', Courier, monospace; 
            font-weight: 700;
            color: #555;
            
            display: flex;
            align-items: center;
            gap: 0.4em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            pointer-events: none;
        }

        /* --- æ¼‚æµ®æç¤º --- */
        .floater {
            position: absolute;
            font-weight: 800;
            animation: floatUp 1.2s forwards;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            font-size: clamp(12px, 4.5vw, 20px);
        }
        .floater.gain { color: #4CAF50; } 
        .floater.passive { color: #FF9800; font-size: clamp(13px, 5vw, 22px); animation-duration: 2s; } 
        .floater.bonus {
            color: #6200EA;
            font-size: clamp(13px, 5vw, 22px);
            background: rgba(255,255,255,0.9);
            padding: 0.25em 0.7em;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, 10%) scale(0.9); }
            15% { opacity: 1; transform: translate(-50%, 0) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -10vh) scale(1); }
        }
    </style>
</head>
<body>

    <div class="stage">
        
        <!-- å·¦ä¸Šè§’ç»„ä»¶ -->
        <div class="collection-widget">
            <div class="cw-icon-box">
                <img id="cw-img" src="" alt="Goal">
            </div>
            <div class="cw-info">
                <span class="cw-label">NEXT</span>
                <span class="cw-value" id="cw-time">--m</span>
            </div>
        </div>

        <!-- ç‹®å­ -->
        <img id="pet-image" src="" alt="Lion" draggable="false" />
        
        <!-- åº•éƒ¨è´´åº•è®¡æ—¶å™¨ -->
        <div class="time-pill">
            <span>â³</span>
            <span id="timer-text">00:00:00</span>
        </div>
    </div>

<script>
// --- å†…ç½®æ°´æ»´éŸ³æ•ˆ (Base64) ---
// è¿™æ˜¯ä¸€ä¸ªçŸ­ä¿ƒçš„ "Bloop" æ°´æ»´å£°
const DROP_SOUND_B64 = "data:audio/wav;base64,UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="; 
// æ³¨æ„ï¼šä¸Šé¢çš„Base64åªæ˜¯å ä½ç¬¦ï¼Œä¸ºäº†ä¿è¯ä»£ç æ•´æ´ï¼Œ
// ä¸‹é¢æˆ‘ä½¿ç”¨ JS AudioContext ç”Ÿæˆä¸€ä¸ªçœŸå®çš„æ°´æ»´éŸ³æ•ˆï¼Œ
// è¿™æ ·æ‚¨ä¸éœ€è¦åŠ è½½ä»»ä½•å¤–éƒ¨æ–‡ä»¶ï¼Œä¹Ÿæ¯”é•¿ Base64 å­—ç¬¦ä¸²æ›´è½»ä¾¿ã€‚

const LION_STAGES = [
    { minMinutes: 0, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_605328cb-0397-4ae6-9d8c-81d9faa9c2cg.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_2fa9c653-032e-4056-9edb-ba6c36f99f3g.png" } },
    { minMinutes: 60, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_0932da40-1ec4-4b08-bcaf-50059a9c590g.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_8714e8cd-a493-4910-a879-a711ce2fcffg.png" } },
    { minMinutes: 1440, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_68b43430-306d-4e8f-adbc-93c98b199a1g.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_75a5ae6c-1eeb-48e4-817d-0b2a0658c98g.png" } },
    { minMinutes: 4320, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_599dfcf7-4217-4ade-aede-04b3bd4674dg.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_469cadec-c139-4113-af5c-741f1c9d19dg.png" } }
];

const ACHIEVEMENTS = [
    { timeMin: 30,     img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_05ff92d2-cec1-48e5-9ce2-89af79bafadg.png" },
    { timeMin: 60,     img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_a938c968-4f9d-44c8-8ecd-f668cbf292ag.png" },
    { timeMin: 180,    img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_052e03b4-d355-4bc1-8905-f4635eeecbdg.png" },
    { timeMin: 360,    img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_3765483f-518b-4905-a1f8-0983d97ce48g.png" },
    { timeMin: 1440,   img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_ab4cafbd-eded-4ba3-a96b-b5f3757869ag.png" },
    { timeMin: 2880,   img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_c98e167c-e338-4c70-8fe6-1c94620cab7g.png" }
];

class CompleteWidget {
    constructor() {
        this.state = { points: 100, totalTimeSec: 0 };
        this.currentStage = 0;
        this.animTimer = null;
        this.PASSIVE_INTERVAL = 60000;
        
        // éŸ³é¢‘ä¸Šä¸‹æ–‡
        this.audioCtx = null;
    }

    init() {
        this.loadData();
        this.updateGrowthStage();
        this.preloadImages();
        this.renderTimer();
        this.renderCollection();
        
        // åˆå§‹åŒ–éŸ³é¢‘ç¯å¢ƒ (ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾)
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if(AudioContext) this.audioCtx = new AudioContext();
        } catch(e) {}

        const petImg = document.getElementById('pet-image');
        if (!petImg.src) this.setPetState('idle');

        setInterval(() => {
            this.state.totalTimeSec++;
            this.updateGrowthStage();
            this.renderTimer();
            this.renderCollection();
            if(this.state.totalTimeSec % 5 === 0) this.saveData();
        }, 1000);

        setInterval(() => {
            this.state.points += 5;
            this.saveData();
            this.showToast("+5 ğŸŒ¹", null, null, 'passive');
        }, this.PASSIVE_INTERVAL);
    }

    // --- æ’­æ”¾æ°´æ»´éŸ³æ•ˆ (åˆæˆå™¨ç”Ÿæˆ) ---
    playDropSound() {
        if (!this.audioCtx) return;
        
        // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ (æœ‰äº›æµè§ˆå™¨åœ¨æ— æ“ä½œåä¼šæŒ‚èµ·)
        if (this.audioCtx.state === 'suspended') {
            this.audioCtx.resume();
        }

        const osc = this.audioCtx.createOscillator();
        const gainNode = this.audioCtx.createGain();

        osc.connect(gainNode);
        gainNode.connect(this.audioCtx.destination);

        // æ¨¡æ‹Ÿæ°´æ»´å£°ï¼šæ­£å¼¦æ³¢ï¼Œé¢‘ç‡å¿«é€Ÿä¸‹é™
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, this.audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, this.audioCtx.currentTime + 0.15);

        // éŸ³é‡åŒ…ç»œ
        gainNode.gain.setValueAtTime(0.5, this.audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioCtx.currentTime + 0.15);

        osc.start();
        osc.stop(this.audioCtx.currentTime + 0.15);
    }

    renderCollection() {
        const currentMins = this.state.totalTimeSec / 60;
        let allMilestones = [];
        LION_STAGES.forEach((s, idx) => {
            if (idx > 0) allMilestones.push({ time: s.minMinutes, src: s.assets.idle });
        });
        ACHIEVEMENTS.forEach(a => allMilestones.push({ time: a.timeMin, src: a.img }));
        allMilestones.sort((a,b) => a.time - b.time);

        const next = allMilestones.find(m => m.time > currentMins);
        const imgEl = document.getElementById('cw-img');
        const timeEl = document.getElementById('cw-time');

        if (next) {
            if(!imgEl.src.includes(next.src)) imgEl.src = next.src;
            const leftMin = Math.ceil(next.time - currentMins);
            timeEl.innerText = leftMin >= 60 ? (leftMin / 60).toFixed(1) + "h" : leftMin + "m";
        } else {
            if(!imgEl.src.includes(LION_STAGES[LION_STAGES.length-1].assets.idle)) {
                imgEl.src = LION_STAGES[LION_STAGES.length-1].assets.idle;
            }
            timeEl.innerText = "MAX";
        }
    }

    renderTimer() {
        const totalSec = this.state.totalTimeSec;
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        const pad = (num) => num < 10 ? '0' + num : num;
        document.getElementById('timer-text').innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    updateGrowthStage() {
        const mins = this.state.totalTimeSec / 60;
        let stageIndex = 0;
        for (let i = 0; i < LION_STAGES.length; i++) {
            if (mins >= LION_STAGES[i].minMinutes) stageIndex = i;
        }
        if (this.currentStage !== stageIndex) {
            this.currentStage = stageIndex;
            this.setPetState('idle');
        }
    }

    handleTouch(e) {
        let clientX = null, clientY = null;
        if (e) {
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.clientX) {
                clientX = e.clientX;
                clientY = e.clientY;
            }
        }

        // æ’­æ”¾éŸ³æ•ˆ
        this.playDropSound();

        this.state.points += 1;
        this.saveData();
        this.setPetState('touch', 800);
        this.showToast("+1 ğŸŒ¹", clientX, clientY, 'gain');

        const bonusChance = Math.random();
        if(bonusChance > 0.98) {
            const bonusSec = Math.floor(Math.random() * 120) + 30;
            this.state.totalTimeSec += bonusSec;
            this.renderTimer();
            this.renderCollection();
            setTimeout(() => {
                this.showToast(`âœ¨ Speed Up +${bonusSec}s`, null, null, 'bonus');
            }, 250);
        }
    }

    setPetState(stateKey, duration = 0) {
        const petImg = document.getElementById('pet-image');
        const currentAssets = LION_STAGES[this.currentStage].assets;
        const target = currentAssets[stateKey] || currentAssets.idle;
        
        if (petImg.src !== target) {
            petImg.src = target;
        }
        
        if (this.animTimer) clearTimeout(this.animTimer);
        if (duration > 0) {
            this.animTimer = setTimeout(() => {
                this.setPetState('idle');
                this.animTimer = null;
            }, duration);
        }
    }

    showToast(text, x, y, type = 'gain') {
        const el = document.createElement('div');
        el.className = `floater ${type}`;
        el.innerText = text;
        
        const vw = window.innerWidth;
        if (x !== null && y !== null) {
            const maxOffset = vw * 0.05; 
            const randomX = (Math.random() - 0.5) * maxOffset;
            let finalX = x + randomX;
            if (finalX < vw * 0.1) finalX = vw * 0.1; 
            if (finalX > vw * 0.9) finalX = vw * 0.9; 
            el.style.left = `${finalX}px`;
            el.style.top = `${y - 40}px`; 
        } else {
            el.style.left = '50%';
            el.style.top = '40%'; 
            el.style.transform = 'translate(-50%, -50%)';
        }
        document.body.appendChild(el);
        setTimeout(() => el.remove(), type === 'passive' ? 2000 : 1200);
    }

    preloadImages() {
        LION_STAGES.forEach(stage => {
            if(stage.assets.idle) (new Image()).src = stage.assets.idle;
            if(stage.assets.touch) (new Image()).src = stage.assets.touch;
        });
        ACHIEVEMENTS.forEach(a => (new Image()).src = a.img);
    }

    saveData() {
        localStorage.setItem('lionRamadanV2', JSON.stringify(this.state));
    }

    loadData() {
        try {
            const saved = localStorage.getItem('lionRamadanV2');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.points !== undefined) this.state.points = parsed.points;
                if (parsed.totalTimeSec !== undefined) this.state.totalTimeSec = parsed.totalTimeSec;
            }
        } catch(e) { console.log("Load error", e); }
    }
}

const widget = new CompleteWidget();
window.onload = () => {
    widget.init();
    const img = document.getElementById('pet-image');
    img.addEventListener('mousedown', (e) => widget.handleTouch(e));
    img.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        widget.handleTouch(e);
    }, {passive: false});
};
</script>
</body>
</html>
