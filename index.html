<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lion Widget Adaptive</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(-45deg, #e0c3fc, #8ec5fc, #90f7ec, #ffecd2);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .stage {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        #pet-image {
            width: 80%;
            max-width: 300px;
            height: auto;
            max-height: 60%; 
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(0 1vh 2vh rgba(0,0,0,0.12)); /* é˜´å½±ä¹Ÿéšè§†å£é«˜åº¦ç¼©æ”¾ */
            margin-bottom: 2vh; 
        }
        #pet-image:active { transform: scale(0.95); }

        /* --- è‡ªé€‚åº”æ—¶é—´èƒ¶å›Š --- */
        .time-pill {
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(8px);
            /* paddingä½¿ç”¨ em å•ä½ï¼Œéšå­—ä½“ç¼©æ”¾ */
            padding: 0.5em 1em; 
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.6);
            
            /* å…³é”®ï¼šå­—ä½“å¤§å°ä½¿ç”¨ clamp è‡ªé€‚åº” */
            /* æœ€å°14pxï¼Œç†æƒ³å¤§å°æ˜¯è§†å£å®½åº¦çš„5%ï¼Œæœ€å¤§24px */
            font-size: clamp(14px, 5vw, 24px); 
            font-family: 'Courier New', Courier, monospace;
            font-weight: 700;
            color: #444;
            
            display: flex;
            align-items: center;
            gap: 0.5em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            pointer-events: none;
        }

        /* --- è‡ªé€‚åº”æ¼‚æµ®æç¤º (é‡ç‚¹ä¼˜åŒ–) --- */
        .floater {
            position: absolute;
            font-weight: 800;
            animation: floatUp 1.2s forwards;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            text-shadow: 0 2px 4px rgba(255,255,255,0.9);
            
            /* é»˜è®¤å­—ä½“ï¼šæœ€å°16pxï¼Œç†æƒ³6vwï¼Œæœ€å¤§32px */
            font-size: clamp(16px, 6vw, 32px);
        }
        
        /* 1. æ™®é€šç‚¹å‡» (+1) */
        .floater.gain { 
            color: #4CAF50; 
        } 
        
        /* 2. æŒ‚æœºå¥–åŠ± (+5) */
        .floater.passive { 
            color: #FF9800; 
            font-size: clamp(14px, 5vw, 28px); /* ç¨å¾®å°ä¸€ç‚¹ */
            animation-duration: 2.5s; /* é£˜å¾—æ…¢ä¸€ç‚¹ */
        } 
        
        /* 3. çˆ†æ—¶é•¿å¥–åŠ± (é«˜äº®) */
        .floater.bonus {
            color: #6200EA;
            /* å­—ä½“æ›´å¤§æ›´é†’ç›® */
            font-size: clamp(18px, 7vw, 36px); 
            background: rgba(255,255,255,0.9);
            padding: 0.3em 0.8em;
            border-radius: 1em;
            box-shadow: 0 0.5em 1.5em rgba(0,0,0,0.15);
            z-index: 101; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
        }
        
        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, 10%) scale(0.8); }
            10% { opacity: 1; transform: translate(-50%, 0) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -15vh) scale(1); } /* ä¸Šå‡è·ç¦»åŸºäºè§†å£é«˜åº¦ */
        }
    </style>
</head>
<body>

    <div class="stage">
        <img id="pet-image" src="" alt="Lion" draggable="false" />
        
        <div class="time-pill">
            <span>â³</span>
            <span id="timer-text">00:00:00</span>
        </div>
    </div>

<script>
// --- èµ„æºé…ç½® (ä¸å˜) ---
const LION_STAGES = [
    { minMinutes: 0, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_605328cb-0397-4ae6-9d8c-81d9faa9c2cg.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_2fa9c653-032e-4056-9edb-ba6c36f99f3g.png" } },
    { minMinutes: 60, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_0932da40-1ec4-4b08-bcaf-50059a9c590g.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_8714e8cd-a493-4910-a879-a711ce2fcffg.png" } },
    { minMinutes: 1440, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_68b43430-306d-4e8f-adbc-93c98b199a1g.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_75a5ae6c-1eeb-48e4-817d-0b2a0658c98g.png" } },
    { minMinutes: 4320, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_599dfcf7-4217-4ade-aede-04b3bd4674dg.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_469cadec-c139-4113-af5c-741f1c9d19dg.png" } }
];

class SimpleWidget {
    constructor() {
        this.state = { points: 100, totalTimeSec: 0 };
        this.currentStage = 0;
        this.animTimer = null;
        this.PASSIVE_INTERVAL = 60000;
    }

    init() {
        this.loadData();
        this.updateGrowthStage();
        this.preloadImages();
        this.renderTimer();
        
        const petImg = document.getElementById('pet-image');
        if (!petImg.src) this.setPetState('idle');

        setInterval(() => {
            this.state.totalTimeSec++;
            this.updateGrowthStage();
            this.renderTimer();
            if(this.state.totalTimeSec % 5 === 0) this.saveData();
        }, 1000);

        setInterval(() => {
            this.state.points += 5;
            this.saveData();
            // æŒ‚æœºå¥–åŠ±ï¼Œä½ç½®å›ºå®šåœ¨å±å¹•ä¸­å¤®ç¨ä¸Šæ–¹
            this.showToast("+5 ğŸŒ¹", null, null, 'passive');
        }, this.PASSIVE_INTERVAL);
    }

    renderTimer() {
        const totalSec = this.state.totalTimeSec;
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        const pad = (num) => num < 10 ? '0' + num : num;
        document.getElementById('timer-text').innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    updateGrowthStage() {
        const mins = this.state.totalTimeSec / 60;
        let stageIndex = 0;
        for (let i = 0; i < LION_STAGES.length; i++) {
            if (mins >= LION_STAGES[i].minMinutes) stageIndex = i;
        }
        if (this.currentStage !== stageIndex) {
            this.currentStage = stageIndex;
            this.setPetState('idle');
        }
    }

    handleTouch(e) {
        let clientX = null, clientY = null;
        if (e) {
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.clientX) {
                clientX = e.clientX;
                clientY = e.clientY;
            }
        }

        this.state.points += 1;
        this.saveData();
        this.setPetState('touch', 800);

        // ç‚¹å‡»å¥–åŠ±
        this.showToast("+1 ğŸŒ¹", clientX, clientY, 'gain');

        const bonusChance = Math.random();
        if(bonusChance > 0.98) {
            const bonusSec = Math.floor(Math.random() * 120) + 30;
            this.state.totalTimeSec += bonusSec;
            this.renderTimer();
            
            // çˆ†æ—¶é•¿å¥–åŠ± (å»¶è¿Ÿä¸€ç‚¹ç‚¹æ˜¾ç¤ºï¼Œå½¢æˆè¿å‡»æ„Ÿ)
            setTimeout(() => {
                this.showToast(`âœ¨ åŠ é€Ÿ +${bonusSec}s`, null, null, 'bonus');
            }, 200);
        }
    }

    setPetState(stateKey, duration = 0) {
        const petImg = document.getElementById('pet-image');
        const currentAssets = LION_STAGES[this.currentStage].assets;
        const target = currentAssets[stateKey] || currentAssets.idle;
        
        if (petImg.src !== target) {
            petImg.src = target;
        }
        
        if (this.animTimer) clearTimeout(this.animTimer);
        if (duration > 0) {
            this.animTimer = setTimeout(() => {
                this.setPetState('idle');
                this.animTimer = null;
            }, duration);
        }
    }

    // --- é€‚é…çš„æ ¸å¿ƒé€»è¾‘ ---
    showToast(text, x, y, type = 'gain') {
        const el = document.createElement('div');
        el.className = `floater ${type}`;
        el.innerText = text;
        
        // è·å–è§†å£å®½åº¦ï¼Œç”¨äºè®¡ç®—åç§»æ¯”ä¾‹
        const vw = window.innerWidth;
        
        if (x !== null && y !== null) {
            // éšæœºæ°´å¹³åç§»ï¼šèŒƒå›´é™åˆ¶åœ¨è§†å£å®½åº¦çš„ 10% ä»¥å†…ï¼Œé˜²æ­¢åç§»è¿‡å¤§
            const maxOffset = vw * 0.1; 
            const randomX = (Math.random() - 0.5) * maxOffset;
            
            // è¾¹ç•Œæ£€æŸ¥ï¼šç¡®ä¿æ–‡å­—ä¸ä¼šè´´åœ¨æœ€å·¦æˆ–æœ€å³è¾¹ç¼˜
            let finalX = x + randomX;
            if (finalX < vw * 0.1) finalX = vw * 0.1; // è‡³å°‘ç•™10%å·¦è¾¹è·
            if (finalX > vw * 0.9) finalX = vw * 0.9; // è‡³å°‘ç•™10%å³è¾¹è·

            el.style.left = `${finalX}px`;
            // å‚ç›´ä½ç½®ç¨å¾®ä¸Šç§»ï¼Œé¿å…æ‰‹æŒ‡é®æŒ¡
            el.style.top = `${y - 50}px`; 
        } else {
            // å±…ä¸­æ˜¾ç¤º (ç”¨äºè¢«åŠ¨å¥–åŠ±æˆ–æ— åæ ‡äº‹ä»¶)
            el.style.left = '50%';
            el.style.top = '45%'; // ç‹®å­å¤´éƒ¨é™„è¿‘
            el.style.transform = 'translate(-50%, -50%)';
        }

        document.body.appendChild(el);
        setTimeout(() => el.remove(), type === 'passive' ? 2500 : 1200);
    }

    preloadImages() {
        LION_STAGES.forEach(stage => {
            if(stage.assets.idle) (new Image()).src = stage.assets.idle;
            if(stage.assets.touch) (new Image()).src = stage.assets.touch;
        });
    }

    saveData() {
        localStorage.setItem('lionRamadanV2', JSON.stringify(this.state));
    }

    loadData() {
        try {
            const saved = localStorage.getItem('lionRamadanV2');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.points !== undefined) this.state.points = parsed.points;
                if (parsed.totalTimeSec !== undefined) this.state.totalTimeSec = parsed.totalTimeSec;
            }
        } catch(e) { console.log("Load error", e); }
    }
}

const simpleWidget = new SimpleWidget();
window.onload = () => {
    simpleWidget.init();
    const img = document.getElementById('pet-image');
    img.addEventListener('mousedown', (e) => simpleWidget.handleTouch(e));
    img.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        simpleWidget.handleTouch(e);
    }, {passive: false});
};
</script>
</body>
</html>
