<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lion Widget v2</title>
    <style>
        :root {
            --primary-blue: #4A90E2;
            --accent-gold: #FFC107;
            --success-green: #4CAF50;
            --text-dark: #444;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(-45deg, #e0c3fc, #8ec5fc, #90f7ec, #ffecd2);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* èƒŒæ™¯è£…é¥°çƒ */
        .bg-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(35px);
            opacity: 0.5;
            z-index: 0;
        }
        .blob-1 { width: 130px; height: 130px; background: rgba(255, 152, 0, 0.4); top: 0; left: -30px; }
        .blob-2 { width: 160px; height: 160px; background: rgba(74, 144, 226, 0.4); bottom: 0; right: -40px; }

        /* --- æ ¸å¿ƒèˆå° --- */
        .stage {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        /* ç‹®å­å›¾ç‰‡ - å¢åŠ åº•éƒ¨ç•™ç™½ç»™æ—¶é—´æ¡ */
        #pet-image {
            width: 75%;
            max-width: 280px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            height: auto;
            max-height: 60%;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(0 8px 20px rgba(0,0,0,0.12));
            z-index: 10;
            margin-bottom: 20px; /* ç»™ä¸‹æ–¹æ—¶é—´æ¡ç•™å‡ºç©ºé—´ */
        }
        #pet-image:active { transform: scale(0.95); }

        /* --- ç»„ä»¶ï¼šå·¦ä¸Šè§’ ä¸‹ä¸€ä¸ªå¥–åŠ± (ç¼©å°ç‰ˆ) --- */
        .next-reward-widget {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 5;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid var(--accent-gold);
            border-radius: 16px;
            padding: 3px 8px 3px 3px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            pointer-events: none;
            /* ä½¿ç”¨å›ºå®šå®½åº¦é™åˆ¶å¤§å°ï¼Œè€Œä¸æ˜¯scaleï¼Œé˜²æ­¢æ¨¡ç³Š */
            max-width: 100px;
        }

        .nr-img-box { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .nr-img-box img { width: 100%; height: 100%; object-fit: contain; }
        .nr-text-group { display: flex; flex-direction: column; line-height: 1.1; }
        .nr-label { font-size: 0.45rem; color: #999; font-weight: 700; letter-spacing: 0.5px; }
        .nr-time { font-size: 0.7rem; color: var(--primary-blue); font-weight: 800; }

        /* --- ç»„ä»¶ï¼šå³ä¸Šè§’ ç§¯åˆ† (ç²¾è‡´ç‰ˆ) --- */
        .mini-score {
            position: absolute;
            top: 12px; right: 12px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 800;
            color: var(--text-dark);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            z-index: 20;
            pointer-events: none;
            display: flex; align-items: center; gap: 4px;
        }
        .mini-score span { color: var(--primary-blue); font-size: 0.8rem; }

        /* --- ç»„ä»¶ï¼šå³ä¾§ å‚ç›´æˆé•¿æ¡ (å˜çª„) --- */
        .right-panel-container {
            position: absolute;
            right: 8px;
            top: 55%;
            transform: translateY(-50%);
            z-index: 5;
            pointer-events: none;
        }

        .growth-sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px 4px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(4px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .growth-icon {
            width: 26px; height: 26px; /* è°ƒå°å›¾æ ‡ */
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #fff;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .growth-icon img { width: 80%; height: 80%; object-fit: contain; }
        .growth-icon.current { border-color: var(--accent-gold); }

        .v-bar-bg {
            width: 6px; height: 60px; /* å˜ç»† */
            background: rgba(255,255,255,0.4);
            border-radius: 4px;
            position: relative;
        }
        .v-bar-fill {
            position: absolute; bottom: 0; left: 0;
            width: 100%; height: 0%;
            background: linear-gradient(to top, #FF9800, #FFEB3B);
            border-radius: 4px;
            transition: height 0.5s ease;
        }

        /* --- æ–°å¢ï¼šåº•éƒ¨ç´¯è®¡æ—¶é—´èƒ¶å›Š --- */
        .time-display-pill {
            position: absolute;
            bottom: 25px; /* è·ç¦»åº•éƒ¨çš„ä½ç½® */
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: #555;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.5);
            z-index: 15;
            pointer-events: none;
        }
        .time-display-pill span {
            font-family: monospace; /* ç­‰å®½å­—ä½“é˜²æ­¢æ•°å­—è·³åŠ¨ */
            font-size: 0.85rem;
            color: var(--primary-blue);
        }

        /* --- æ¼‚æµ®æ–‡å­—åŠ¨ç”» --- */
        .floater {
            position: absolute;
            font-weight: 900;
            animation: floatUp 0.8s forwards;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
        }
        .floater.gain { 
            color: var(--success-green); 
            font-size: 1.2rem; 
            text-shadow: 0 1px 2px rgba(255,255,255,1); 
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translate(-50%, 0) scale(0.8); }
            50% { transform: translate(-50%, -30px) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -60px) scale(1); }
        }
    </style>
</head>
<body>

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <!-- å³ä¸Šè§’ï¼šç§¯åˆ† -->
    <div class="mini-score">ğŸŒ¹ <span id="mini-score-val">0</span></div>

    <div class="stage">
        
        <!-- å·¦ä¸Šè§’ï¼šç›®æ ‡ -->
        <div id="next-reward-widget" class="next-reward-widget">
            <div class="nr-img-box">
                <img id="nr-img" src="" alt="Reward">
            </div>
            <div class="nr-text-group">
                <span class="nr-label">GOAL</span>
                <span id="nr-time" class="nr-time">--</span>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šç‹®å­ -->
        <img id="pet-image" src="" alt="Lion" draggable="false" />

        <!-- åº•éƒ¨ï¼šç´¯è®¡æ—¶é•¿ (æ–°å¢) -->
        <div class="time-display-pill">
            â³ <span id="total-time-text">0h 00m</span>
        </div>
        
        <!-- å³ä¾§ï¼šæˆé•¿æ¡ -->
        <div class="right-panel-container">
            <div class="growth-sidebar">
                <div class="growth-icon next">
                    <img id="next-stage-icon" src="" alt="Next">
                </div>
                <div class="v-bar-bg">
                    <div id="growth-fill" class="v-bar-fill"></div>
                </div>
                <div class="growth-icon current">
                    <img id="current-stage-icon" src="" alt="Current">
                </div>
            </div>
        </div>

    </div>

<script>
// --- æ•°æ®å¸¸é‡ ---
const LION_STAGES = [
    { minMinutes: 0, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_605328cb-0397-4ae6-9d8c-81d9faa9c2cg.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_2fa9c653-032e-4056-9edb-ba6c36f99f3g.png" } },
    { minMinutes: 60, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_0932da40-1ec4-4b08-bcaf-50059a9c590g.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_8714e8cd-a493-4910-a879-a711ce2fcffg.png" } },
    { minMinutes: 1440, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_68b43430-306d-4e8f-adbc-93c98b199a1g.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_75a5ae6c-1eeb-48e4-817d-0b2a0658c98g.png" } },
    { minMinutes: 4320, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_599dfcf7-4217-4ade-aede-04b3bd4674dg.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_469cadec-c139-4113-af5c-741f1c9d19dg.png" } }
];

const ACHIEVEMENTS = [
    { timeMin: 1,      img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_a855cdd3-3897-475f-b5d5-707171d8843g.png" },
    { timeMin: 30,     img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_05ff92d2-cec1-48e5-9ce2-89af79bafadg.png" },
    { timeMin: 60,     img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_a938c968-4f9d-44c8-8ecd-f668cbf292ag.png" },
    { timeMin: 180,    img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_052e03b4-d355-4bc1-8905-f4635eeecbdg.png" },
    { timeMin: 360,    img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_3765483f-518b-4905-a1f8-0983d97ce48g.png" },
    { timeMin: 1440,   img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_ab4cafbd-eded-4ba3-a96b-b5f3757869ag.png" }, 
    { timeMin: 2880,   img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_c98e167c-e338-4c70-8fe6-1c94620cab7g.png" } 
];

class WidgetGame {
    constructor() {
        this.state = {
            points: 100,
            totalTimeSec: 0
        };
        this.currentStage = 0;
        this.animTimer = null;
    }

    init() {
        this.loadData();
        this.updateGrowthStage();
        this.render(); 
        this.preloadImages();
        
        setInterval(() => {
            this.state.totalTimeSec++;
            this.updateGrowthStage();
            this.renderGrowth();
            this.renderTotalTime(); // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            if(this.state.totalTimeSec % 5 === 0) this.saveData();
        }, 1000);
    }

    updateGrowthStage() {
        const mins = this.state.totalTimeSec / 60;
        let stageIndex = 0;
        for (let i = 0; i < LION_STAGES.length; i++) {
            if (mins >= LION_STAGES[i].minMinutes) stageIndex = i;
        }
        if (this.currentStage !== stageIndex) {
            this.currentStage = stageIndex;
            this.setPetState('idle');
        }
    }

    render() {
        this.renderPoints();
        this.renderGrowth();
        this.renderTotalTime();
        
        const petImg = document.getElementById('pet-image');
        if (!petImg.src) this.setPetState('idle');
    }

    renderPoints() {
        document.getElementById('mini-score-val').innerText = this.state.points;
    }

    // æ–°å¢ï¼šæ¸²æŸ“ç´¯è®¡æ—¶é—´
    renderTotalTime() {
        const sec = this.state.totalTimeSec;
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        // æ ¼å¼åŒ–ä¸º 0h 00m
        const mStr = m < 10 ? '0' + m : m;
        document.getElementById('total-time-text').innerText = `${h}h ${mStr}m`;
    }

    renderGrowth() {
        const currentMins = this.state.totalTimeSec / 60;
        const currentStageObj = LION_STAGES[this.currentStage];
        const nextStageObj = LION_STAGES[this.currentStage + 1];

        // æˆé•¿æ¡
        const nextIcon = document.getElementById('next-stage-icon');
        const currentIcon = document.getElementById('current-stage-icon');
        const fill = document.getElementById('growth-fill');

        if (!nextStageObj) {
            fill.style.height = '100%';
            nextIcon.src = currentStageObj.assets.idle;
            currentIcon.src = currentStageObj.assets.idle;
        } else {
            currentIcon.src = currentStageObj.assets.idle;
            nextIcon.src = nextStageObj.assets.idle;
            const startMins = currentStageObj.minMinutes;
            const targetMins = nextStageObj.minMinutes;
            const progress = ((currentMins - startMins) / (targetMins - startMins)) * 100;
            fill.style.height = `${Math.min(100, Math.max(0, progress))}%`;
        }

        // ç›®æ ‡ç»„ä»¶
        const wImg = document.getElementById('nr-img');
        const wTime = document.getElementById('nr-time');
        
        let allMilestones = [];
        LION_STAGES.forEach((s, idx) => {
            if (idx > 0) allMilestones.push({ time: s.minMinutes, src: s.assets.idle });
        });
        ACHIEVEMENTS.forEach(a => allMilestones.push({ time: a.timeMin, src: a.img }));
        allMilestones.sort((a,b) => a.time - b.time);

        const next = allMilestones.find(m => m.time > currentMins);

        if (next) {
            wImg.src = next.src;
            const left = Math.ceil(next.time - currentMins);
            // ç®€åŒ–æ˜¾ç¤º
            wTime.innerText = left >= 60 ? (left/60).toFixed(1) + "h" : left + "m";
        } else {
            wImg.src = LION_STAGES[LION_STAGES.length-1].assets.idle;
            wTime.innerText = "MAX";
        }
    }

    handleTouch(e) {
        let clientX = null, clientY = null;
        if (e) {
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.clientX) {
                clientX = e.clientX;
                clientY = e.clientY;
            }
        }

        this.state.points += 1;
        this.renderPoints();
        this.saveData();

        this.setPetState('touch', 800);
        this.showToast("+1 ğŸŒ¹", clientX, clientY);
    }

    setPetState(stateKey, duration = 0) {
        const petImg = document.getElementById('pet-image');
        const currentAssets = LION_STAGES[this.currentStage].assets;
        const target = currentAssets[stateKey] || currentAssets.idle;
        
        if (petImg.src !== target) {
            petImg.src = target;
        }
        
        if (this.animTimer) clearTimeout(this.animTimer);
        if (duration > 0) {
            this.animTimer = setTimeout(() => {
                this.setPetState('idle');
                this.animTimer = null;
            }, duration);
        }
    }

    showToast(text, x, y) {
        const el = document.createElement('div');
        el.className = 'floater gain';
        el.innerText = text;
        
        if (x !== null && y !== null) {
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
        } else {
            el.style.left = '50%';
            el.style.top = '45%';
            el.style.transform = 'translate(-50%, -50%)';
        }

        document.body.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    preloadImages() {
        LION_STAGES.forEach(stage => {
            if(stage.assets.idle) (new Image()).src = stage.assets.idle;
            if(stage.assets.touch) (new Image()).src = stage.assets.touch;
        });
    }

    saveData() {
        localStorage.setItem('lionRamadanV2', JSON.stringify(this.state));
    }

    loadData() {
        try {
            const saved = localStorage.getItem('lionRamadanV2');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.points !== undefined) this.state.points = parsed.points;
                if (parsed.totalTimeSec !== undefined) this.state.totalTimeSec = parsed.totalTimeSec;
            }
        } catch(e) { console.log("Load error", e); }
    }
}

const widget = new WidgetGame();
window.onload = () => {
    widget.init();
    const img = document.getElementById('pet-image');
    img.addEventListener('mousedown', (e) => widget.handleTouch(e));
    img.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        widget.handleTouch(e);
    }, {passive: false});
};
</script>
</body>
</html>
