<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lion Widget Complete</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(-45deg, #e0c3fc, #8ec5fc, #90f7ec, #ffecd2);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .stage {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        /* --- å·¦ä¸Šè§’ï¼šæ”¶è—é¦†å°ç»„ä»¶ (æ–°å¢) --- */
        .collection-widget {
            position: absolute;
            /* è·ç¦»é¡¶éƒ¨å’Œå·¦ä¾§çš„è·ç¦»ï¼Œéšè§†å£ç¼©æ”¾ */
            top: 2vh; 
            left: 3vw;
            
            /* å­—ä½“å¤§å°åŸºå‡†ï¼šé€‚é…çš„å…³é”® */
            /* æœ€å°10pxï¼Œæ­£å¸¸3.5vwï¼Œæœ€å¤§16px */
            font-size: clamp(10px, 3.5vw, 16px);
            
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(5px);
            border: 0.5px solid rgba(255,255,255,0.6);
            border-radius: 12px;
            
            /* å†…è¾¹è·éšå­—ä½“å¤§å°ç¼©æ”¾ */
            padding: 0.4em 0.8em 0.4em 0.4em; 
            
            display: flex;
            align-items: center;
            gap: 0.5em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            pointer-events: none; /* çº¯å±•ç¤ºï¼Œä¸é˜»æŒ¡ç‚¹å‡» */
            z-index: 20;
            
            /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ–‡å­—è¿‡é•¿ */
            max-width: 45vw;
        }

        .cw-icon-box {
            /* å›¾æ ‡å¤§å°éšå­—ä½“ç¼©æ”¾ï¼Œçº¦ç­‰äº2.2å€å­—ä½“å¤§å° */
            width: 2.2em;
            height: 2.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            padding: 2px;
        }
        .cw-icon-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .cw-info {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }
        
        .cw-label {
            font-size: 0.7em; /* æ¯”åŸºå‡†å­—ä½“å° */
            color: #666;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .cw-value {
            font-size: 1.1em; /* æ¯”åŸºå‡†å­—ä½“å¤§ */
            color: #6200EA; /* ç´«è‰²é«˜äº® */
            font-weight: 800;
        }

        /* --- ç‹®å­ä¸»ä½“ --- */
        #pet-image {
            width: 75vw;
            max-width: 280px;
            height: auto;
            max-height: 55vh; /* ç¨å¾®å‡å°é«˜åº¦ï¼Œé˜²æ­¢é®æŒ¡ä¸Šæ–¹ç»„ä»¶ */
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(0 1vh 2vh rgba(0,0,0,0.12));
            margin-bottom: 1.5vh;
        }
        #pet-image:active { transform: scale(0.95); }

        /* --- åº•éƒ¨è®¡æ—¶å™¨ --- */
        .time-pill {
            font-size: clamp(10px, 3.5vw, 16px);
            padding: 0.3em 0.8em;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(6px);
            border-radius: 12px;
            border: 0.5px solid rgba(255,255,255,0.5);
            font-family: 'Courier New', Courier, monospace; 
            font-weight: 700;
            color: #555;
            display: flex;
            align-items: center;
            gap: 0.4em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            pointer-events: none;
        }

        /* --- æ¼‚æµ®æç¤º --- */
        .floater {
            position: absolute;
            font-weight: 800;
            animation: floatUp 1.2s forwards;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            font-size: clamp(12px, 4.5vw, 20px);
        }
        .floater.gain { color: #4CAF50; } 
        .floater.passive { color: #FF9800; font-size: clamp(13px, 5vw, 22px); animation-duration: 2s; } 
        .floater.bonus {
            color: #6200EA;
            font-size: clamp(13px, 5vw, 22px);
            background: rgba(255,255,255,0.85);
            padding: 0.25em 0.7em;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, 10%) scale(0.9); }
            15% { opacity: 1; transform: translate(-50%, 0) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -10vh) scale(1); }
        }
    </style>
</head>
<body>

    <div class="stage">
        
        <!-- å·¦ä¸Šè§’ï¼šæ”¶è—é¦†/ç›®æ ‡ç»„ä»¶ -->
        <div class="collection-widget" id="collection-widget">
            <div class="cw-icon-box">
                <img id="cw-img" src="" alt="Goal">
            </div>
            <div class="cw-info">
                <span class="cw-label">NEXT</span>
                <span class="cw-value" id="cw-time">--m</span>
            </div>
        </div>

        <img id="pet-image" src="" alt="Lion" draggable="false" />
        
        <div class="time-pill">
            <span>â³</span>
            <span id="timer-text">00:00:00</span>
        </div>
    </div>

<script>
// --- æ•°æ®å¸¸é‡ ---
const LION_STAGES = [
    { minMinutes: 0, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_605328cb-0397-4ae6-9d8c-81d9faa9c2cg.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_2fa9c653-032e-4056-9edb-ba6c36f99f3g.png" } },
    { minMinutes: 60, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_0932da40-1ec4-4b08-bcaf-50059a9c590g.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_8714e8cd-a493-4910-a879-a711ce2fcffg.png" } },
    { minMinutes: 1440, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_68b43430-306d-4e8f-adbc-93c98b199a1g.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_75a5ae6c-1eeb-48e4-817d-0b2a0658c98g.png" } },
    { minMinutes: 4320, assets: { idle: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_599dfcf7-4217-4ade-aede-04b3bd4674dg.png", touch: "https://cos-cdn.kk6277.com/feishu/img_v3_02tt_469cadec-c139-4113-af5c-741f1c9d19dg.png" } }
];

// å¥–åŠ±åˆ—è¡¨ï¼šç›¸æ¡†ã€è½¦ã€å¾½ç« 
const ACHIEVEMENTS = [
    { timeMin: 30,     img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_05ff92d2-cec1-48e5-9ce2-89af79bafadg.png" }, // æ˜Ÿæ˜Ÿæ¡†
    { timeMin: 60,     img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_a938c968-4f9d-44c8-8ecd-f668cbf292ag.png" }, // é‡‘æ¡†
    { timeMin: 180,    img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_052e03b4-d355-4bc1-8905-f4635eeecbdg.png" }, // çº¢è½¦
    { timeMin: 360,    img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_3765483f-518b-4905-a1f8-0983d97ce48g.png" }, // è“è½¦
    { timeMin: 1440,   img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_ab4cafbd-eded-4ba3-a96b-b5f3757869ag.png" }, // è¶…è·‘
    { timeMin: 2880,   img: "https://cos-cdn.kk6277.com/feishu/img_v3_02tc_c98e167c-e338-4c70-8fe6-1c94620cab7g.png" }  // å‹‹ç« 
];

class CompleteWidget {
    constructor() {
        this.state = { points: 100, totalTimeSec: 0 };
        this.currentStage = 0;
        this.animTimer = null;
        this.PASSIVE_INTERVAL = 60000;
    }

    init() {
        this.loadData();
        this.updateGrowthStage();
        this.preloadImages();
        this.renderTimer();
        this.renderCollection(); // æ¸²æŸ“å·¦ä¸Šè§’ç»„ä»¶
        
        const petImg = document.getElementById('pet-image');
        if (!petImg.src) this.setPetState('idle');

        setInterval(() => {
            this.state.totalTimeSec++;
            this.updateGrowthStage();
            this.renderTimer();
            this.renderCollection(); // å®æ—¶æ›´æ–°ç›®æ ‡æ—¶é—´
            if(this.state.totalTimeSec % 5 === 0) this.saveData();
        }, 1000);

        setInterval(() => {
            this.state.points += 5;
            this.saveData();
            this.showToast("+5 ğŸŒ¹", null, null, 'passive');
        }, this.PASSIVE_INTERVAL);
    }

    // --- æ¸²æŸ“å·¦ä¸Šè§’æ”¶è—é¦†ç»„ä»¶ ---
    renderCollection() {
        const currentMins = this.state.totalTimeSec / 60;
        
        // 1. åˆå¹¶æ‰€æœ‰é‡Œç¨‹ç¢‘ï¼ˆè¿›åŒ–é˜¶æ®µ + é“å…·ï¼‰
        let allMilestones = [];
        // ä»ç¬¬2ä¸ªé˜¶æ®µå¼€å§‹ç®—é‡Œç¨‹ç¢‘ (ç¬¬1ä¸ªæ˜¯åˆå§‹çŠ¶æ€)
        LION_STAGES.forEach((s, idx) => {
            if (idx > 0) allMilestones.push({ time: s.minMinutes, src: s.assets.idle });
        });
        // åŠ å…¥é“å…·å¥–åŠ±
        ACHIEVEMENTS.forEach(a => allMilestones.push({ time: a.timeMin, src: a.img }));
        
        // æŒ‰æ—¶é—´æ’åº
        allMilestones.sort((a,b) => a.time - b.time);

        // 2. æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœªè¾¾æˆçš„ç›®æ ‡
        const next = allMilestones.find(m => m.time > currentMins);
        
        const imgEl = document.getElementById('cw-img');
        const timeEl = document.getElementById('cw-time');

        if (next) {
            // æ˜¾ç¤ºç›®æ ‡å›¾æ ‡
            const path = next.src;
            // é¿å…é‡å¤èµ‹å€¼å¼•èµ·é—ªçƒ
            if(!imgEl.src.includes(path)) imgEl.src = path;

            // è®¡ç®—å‰©ä½™æ—¶é—´
            const leftMin = Math.ceil(next.time - currentMins);
            if (leftMin >= 60) {
                timeEl.innerText = (leftMin / 60).toFixed(1) + "h";
            } else {
                timeEl.innerText = leftMin + "m";
            }
        } else {
            // å·²æ»¡çº§
            if(!imgEl.src.includes(LION_STAGES[LION_STAGES.length-1].assets.idle)) {
                imgEl.src = LION_STAGES[LION_STAGES.length-1].assets.idle;
            }
            timeEl.innerText = "MAX";
        }
    }

    renderTimer() {
        const totalSec = this.state.totalTimeSec;
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        const pad = (num) => num < 10 ? '0' + num : num;
        document.getElementById('timer-text').innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;
    }

    updateGrowthStage() {
        const mins = this.state.totalTimeSec / 60;
        let stageIndex = 0;
        for (let i = 0; i < LION_STAGES.length; i++) {
            if (mins >= LION_STAGES[i].minMinutes) stageIndex = i;
        }
        if (this.currentStage !== stageIndex) {
            this.currentStage = stageIndex;
            this.setPetState('idle');
        }
    }

    handleTouch(e) {
        let clientX = null, clientY = null;
        if (e) {
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else if (e.clientX) {
                clientX = e.clientX;
                clientY = e.clientY;
            }
        }

        this.state.points += 1;
        this.saveData();
        this.setPetState('touch', 800);

        this.showToast("+1 ğŸŒ¹", clientX, clientY, 'gain');

        const bonusChance = Math.random();
        if(bonusChance > 0.98) {
            const bonusSec = Math.floor(Math.random() * 120) + 30;
            this.state.totalTimeSec += bonusSec;
            this.renderTimer();
            this.renderCollection(); // æ—¶é—´å¢åŠ å¯èƒ½è§¦å‘ç›®æ ‡æ›´æ–°
            
            setTimeout(() => {
                this.showToast(`âœ¨ Speed Up +${bonusSec}s`, null, null, 'bonus');
            }, 250);
        }
    }

    setPetState(stateKey, duration = 0) {
        const petImg = document.getElementById('pet-image');
        const currentAssets = LION_STAGES[this.currentStage].assets;
        const target = currentAssets[stateKey] || currentAssets.idle;
        
        if (petImg.src !== target) {
            petImg.src = target;
        }
        
        if (this.animTimer) clearTimeout(this.animTimer);
        if (duration > 0) {
            this.animTimer = setTimeout(() => {
                this.setPetState('idle');
                this.animTimer = null;
            }, duration);
        }
    }

    showToast(text, x, y, type = 'gain') {
        const el = document.createElement('div');
        el.className = `floater ${type}`;
        el.innerText = text;
        
        const vw = window.innerWidth;
        
        if (x !== null && y !== null) {
            const maxOffset = vw * 0.05; 
            const randomX = (Math.random() - 0.5) * maxOffset;
            
            let finalX = x + randomX;
            if (finalX < vw * 0.1) finalX = vw * 0.1; 
            if (finalX > vw * 0.9) finalX = vw * 0.9; 

            el.style.left = `${finalX}px`;
            el.style.top = `${y - 40}px`; 
        } else {
            el.style.left = '50%';
            el.style.top = '40%'; 
            el.style.transform = 'translate(-50%, -50%)';
        }

        document.body.appendChild(el);
        setTimeout(() => el.remove(), type === 'passive' ? 2000 : 1200);
    }

    preloadImages() {
        LION_STAGES.forEach(stage => {
            if(stage.assets.idle) (new Image()).src = stage.assets.idle;
            if(stage.assets.touch) (new Image()).src = stage.assets.touch;
        });
        ACHIEVEMENTS.forEach(a => (new Image()).src = a.img);
    }

    saveData() {
        localStorage.setItem('lionRamadanV2', JSON.stringify(this.state));
    }

    loadData() {
        try {
            const saved = localStorage.getItem('lionRamadanV2');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.points !== undefined) this.state.points = parsed.points;
                if (parsed.totalTimeSec !== undefined) this.state.totalTimeSec = parsed.totalTimeSec;
            }
        } catch(e) { console.log("Load error", e); }
    }
}

const widget = new CompleteWidget();
window.onload = () => {
    widget.init();
    const img = document.getElementById('pet-image');
    img.addEventListener('mousedown', (e) => widget.handleTouch(e));
    img.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        widget.handleTouch(e);
    }, {passive: false});
};
</script>
</body>
</html>
